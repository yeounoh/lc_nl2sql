## 1\.2\. Untrusted SQLite Database Files


Applications that read or write SQLite database files of uncertain
provenance should take precautions enumerated below.



Even if the application does not deliberately accept database files 
from untrusted sources, beware of attacks in which a local 
database file is altered. For best security, any database file which 
might have ever been writable by an agent in a different security domain
should be treated as suspect.



1. If the application includes any [custom SQL functions](appfunc.html) or 
[custom virtual tables](vtab.html#customvtab) that have side effects or that might leak
privileged information, then the application should use one or more
of the techniques below to prevent a maliciously crafted database
schema from surreptitiously running those SQL functions and/or
virtual tables for nefarious purposes:



	1. Invoke [sqlite3\_db\_config](c3ref/db_config.html)(db,[SQLITE\_DBCONFIG\_TRUSTED\_SCHEMA](c3ref/c_dbconfig_defensive.html#sqlitedbconfigtrustedschema),0,0\)
	 on each [database connection](c3ref/sqlite3.html) as soon as it is opened.
	2. Run the [PRAGMA trusted\_schema\=OFF](pragma.html#pragma_trusted_schema) statement on each database connection
	 as soon as it is opened.
	3. Compile SQLite using the [\-DSQLITE\_TRUSTED\_SCHEMA\=0](compile.html#trusted_schema) compile\-time option.
	4. Disable the surreptitious use of custom SQL functions and virtual tables
	 by setting the [SQLITE\_DIRECTONLY](c3ref/c_deterministic.html#sqlitedirectonly) flag on all custom SQL functions and
	 the [SQLITE\_VTAB\_DIRECTONLY](c3ref/c_vtab_constraint_support.html#sqlitevtabdirectonly) flag on all custom virtual tables.
2. If the application does not use triggers or views, consider disabling the
unused capabilities with:



> ```
> 
> [sqlite3_db_config](c3ref/db_config.html)(db,[SQLITE_DBCONFIG_ENABLE_TRIGGER](c3ref/c_dbconfig_defensive.html#sqlitedbconfigenabletrigger),0,0);
> [sqlite3_db_config](c3ref/db_config.html)(db,[SQLITE_DBCONFIG_ENABLE_VIEW](c3ref/c_dbconfig_defensive.html#sqlitedbconfigenableview),0,0);
> 
> ```



For reading database files that are unusually high\-risk, such as database
files that are received from remote machines, and possibly from anonymous
contributors, the following extra precautions
might be justified. These added defenses come with performance costs,
however, and so may not be appropriate in every situation:



1. Run [PRAGMA integrity\_check](pragma.html#pragma_integrity_check) or [PRAGMA quick\_check](pragma.html#pragma_quick_check) on the database
as the first SQL statement after opening the database files and
prior to running any other SQL statements. Reject and refuse to
process any database file containing errors.
2. Enable the [PRAGMA cell\_size\_check\=ON](pragma.html#pragma_cell_size_check) setting.
3. Do not enable memory\-mapped I/O.
In other words, make sure that [PRAGMA mmap\_size\=0](pragma.html#pragma_mmap_size).


