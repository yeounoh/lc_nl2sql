### 4\.1 Dealing with hot journals



Before reading from a database file, SQLite always checks to see if that
database file has a hot journal. If the file does have a hot journal, then
the journal is rolled back before the file is read. In this way, we ensure
that the database file is in a consistent state before it is read.



When a process wants to read from a database file, it followed
the following sequence of steps:



1. Open the database file and obtain a SHARED lock. If the SHARED lock
 cannot be obtained, fail immediately and return SQLITE\_BUSY.
2. Check to see if the database file has a hot journal. If the file
 does not have a hot journal, we are done. Return immediately.
 If there is a hot journal, that journal must be rolled back by
 the subsequent steps of this algorithm.
3. Acquire a PENDING lock then an EXCLUSIVE lock on the database file.
 (Note: Do not acquire a RESERVED lock because that would make
 other processes think the journal was no longer hot.) If we
 fail to acquire these locks it means another process
 is already trying to do the rollback. In that case,
 drop all locks, close the database, and return SQLITE\_BUSY.
4. Read the journal file and roll back the changes.
5. Wait for the rolled back changes to be written onto 
 persistent storage. This protects the integrity of the database
 in case another power failure or crash occurs.
6. Delete the journal file (or truncate the journal to zero bytes in
 length if [PRAGMA journal\_mode\=TRUNCATE](pragma.html#pragma_journal_mode) is
 set, or zero the journal header if
 [PRAGMA journal\_mode\=PERSIST](pragma.html#pragma_journal_mode) is set).
7. Delete the super\-journal file if it is safe to do so.
 This step is optional. It is here only to prevent stale
 super\-journals from cluttering up the disk drive.
 See the discussion below for details.
8. Drop the EXCLUSIVE and PENDING locks but retain the SHARED lock.


After the algorithm above completes successfully, it is safe to 
read from the database file. Once all reading has completed, the
SHARED lock is dropped.



