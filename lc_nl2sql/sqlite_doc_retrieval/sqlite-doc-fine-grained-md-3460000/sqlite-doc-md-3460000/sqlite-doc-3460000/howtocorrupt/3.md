## 1\.1\.  Continuing to use a file descriptor after it has been closed


We have seen multiple cases where a file descriptor was open on a file,
then that file descriptor was closed and reopened on an SQLite database.
Later, some other thread continued to write into the
old file descriptor, not realizing that the original file had been closed
already. But because the file descriptor had been reopened by SQLite,
the information that was intended to go into the original file ended up
overwriting parts of the SQLite database, leading to corruption of the
database.


One example of this occurred circa 2013\-08\-30 on the canonical repository
for the [Fossil DVCS](http://www.fossil-scm.org/). In that event,
file descriptor 2 (standard error) was being erroneously closed (by
[stunnel](http://www.stunnel.org/), we suspect) prior to 
[sqlite3\_open\_v2()](c3ref/open.html) so that the file descriptor used for the
repository database file was 2\. Later, an application 
bug caused an assert() statement to emit
an error message by invoking write(2,...). But since file descriptor 2 was 
now connected to a database file, the error message
overwrote part of the database. To guard against this kind of problem,
SQLite [version 3\.8\.1](releaselog/3_8_1.html) (2013\-10\-17\)
and later refuse to use low\-numbered file descriptors
for database files. 
(See [SQLITE\_MINIMUM\_FILE\_DESCRIPTOR](compile.html#minimum_file_descriptor) for additional information.)


Another example of corruption caused by using a closed file
descriptor was 
[reported by facebook engineers](https://code.facebook.com/posts/313033472212144/debugging-file-corruption-on-ios/) in a blog post on 2014\-08\-12\.


Another example of this error was reported against
[Fossil](https://fossil-scm.org/) on 2019\-07\-11\. A file descriptor would
be opened for debugging output, but then closed and reopened by SQLite.
But the debugging logic continued to write into the original file
descriptor. See the
[forum discussion](https://fossil-scm.org/forum/forumpost/c51b9a1169)
for the bug report and a link to the fix.



