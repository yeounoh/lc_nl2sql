## 8\.7\.  Boundary value error in the secondary journals used by nested transactions


When a nested transaction is started using [SAVEPOINT](lang_savepoint.html), SQLite uses
a secondary rollback journal to track the changes for the nested
transaction, in case the inner transaction needs to be rolled back. Secondary
journals are not involved in protecting the database from corruption due
to program crashes or power outages. The secondary journals only come into
play when rolling back an inner transaction of a nested transaction.



These secondary journals can be held either in memory or as temporary
files on disk. The default behavior is to store them on disk. But that 
can be changed using the [\-DSQLITE\_TEMP\_STORE](compile.html#temp_store) compile\-time option,
or at run\-time using the [PRAGMA temp\_store](pragma.html#pragma_temp_store) statement. The bug
only arises when secondary journals are held in memory.



In SQLite [version 3\.35\.0](releaselog/3_35_0.html) (2021\-03\-12\), a new optimization was
added so that when SQLite is holding secondary journals in memory,
less memory will be used. Unfortunately, an boundary check in
the new logic was coded incorrectly.
What should have been a "\<" operator was coded as "\<\=". This
error might cause the secondary journal to enter an inconsistent state
if it is ever rolled back. If additional changes are made and the
outer transaction eventually commits, the database might be left in
an inconsistent state.



This problem was discovered by an 
[independent researcher](https://sqlite.org/forum/forumpost/b03d86f9516cb3a2)
who was attempting to find bugs in SQLite using a fuzzer. The fuzzer found a
failure in an [assert() statement](assert.html) that is used
to help verify the internal state of the secondary journal. The bug was a
sufficiently obscure corner\-case that it might have gone unnoticed for many
years, had it not been for the intensive use of assert() statements in SQLite,
the persistence and tenacity of the security researchers, and their
customized state\-of\-the\-art fuzzer.



This problem was [fixed](https://www.sqlite.org/src/info/73c2b50211d3ae26)
in [version 3\.37\.2](releaselog/3_37_2.html) (2022\-01\-06\).



