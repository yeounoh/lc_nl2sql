## 7\.5\.  Filesystems With Safe Append Semantics


Another optimization introduced in SQLite version 3\.5\.0 makes
use of "safe append" behavior of the underlying disk.
Recall that SQLite assumes that when data is appended to a file
(specifically to the rollback journal) that the size of the file
is increased first and that the content is written second. So
if power is lost after the file size is increased but before the
content is written, the file is left containing invalid "garbage"
data. The xDeviceCharacteristics method of the VFS might, however,
indicate that the filesystem implements "safe append" semantics.
This means that the content is written before the file size is
increased so that it is impossible for garbage to be introduced
into the rollback journal by a power loss or system crash.


When safe append semantics are indicated for a filesystem,
SQLite always stores the special value of \-1 for the page count
in the header of the rollback journal. The \-1 page count value
tells any process attempting to rollback the journal that the
number of pages in the journal should be computed from the journal
size. This \-1 value is never changed. So that when a commit
occurs, we save a single flush operation and a sector write of
the first page of the journal file. Furthermore, when a cache
spill occurs we no longer need to append a new journal header
to the end of the journal; we can simply continue appending
new pages to the end of the existing journal.



