## 3\.1\.  Query Details



TPC\-H Q8 is an eight\-way join.
As observed above, the main task of the query planner is
to figure out the best nesting order of the eight loops in order to minimize
the work needed to complete the join.
A simplified model of this problem for the case of TPC\-H Q8 is shown
by the following diagram:






S

L

O

C

N1

R

P

N2


6\.00


2\.08


9\.17


2\.30


2\.77


4\.03


2\.64


5\.30


2\.08


6\.40


1\.79


3\.47


2\.64


6\.01

\*


 5\.52

\*


 9\.47

\*


 16\.40

\*


 13\.87

\*


 12\.56

\*


 5\.52

\*


 3\.56

\*


 7\.71




In the diagram, each of the 8 tables in the FROM clause of the query is
identified by a large circle with the label of the FROM\-clause term:
N2, S, L, P, O, C, N1 and R.
The arcs in the graph represent the estimated cost of computing each term
assuming that the origin of the arc is in an outer loop. For example, the
cost of running the S loop as an inner loop to L is 2\.30 whereas the
cost of running the S loop as an outer loop to L is 9\.17\.


The "cost" here is logarithmic. With nested loops, the work
is multiplied, not added. But it is customary to think of graphs
with additive weights and so the graph shows the logarithm of the
various costs. The graph shows a cost advantage of S being inside of
L of about 6\.87, but this translates into the query running about
963 times faster when S loop is inside of the L loop rather than
being outside of it.


The arrows from the small circles labeled with "\*" indicate the cost
of running each loop with no dependencies. The outermost loop must use this
\*\-cost. Inner loops have the option of using the \*\-cost or a cost assuming
one of the other terms is in an outer loop, whichever gives the best
result. One can think of the \*\-costs as a short\-hand notation indicating
multiple arcs, one from each of the other nodes in the
graph. The graph is therefore "complete", meaning that there are arcs
(some explicit and some implied) in both directions between every pair of
nodes in the graph.


The problem of finding the best query plan is equivalent to finding
a minimum\-cost path through the graph that visits each node
exactly once.


(Side note: The cost estimates in the TPC\-H Q8 graph above were computed
by the query planner in SQLite 3\.7\.16 and converted using a natural logarithm.)



