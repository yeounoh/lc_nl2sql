# 4\.  Hazards Of Upgrading To NGQP


*→ Update: **This section is obsolete and retained for
historical reference only.** This section was important
when the NGQP was new. But a decade has elapsed, the NGQP has been
deployed successfully to billions of devices, and everyone has upgraded,
and no performance regressions were ever reported back to the SQLite
developers. The upgrade hazard has vanished.
This section is retained for historical reference only.
Modern readers can **skip ahead to the [query planner checklist](queryplanner-ng.html#howtofix)**.←*


For most applications, upgrading from the legacy query planner to the NGQP
requires little thought or effort.
Simply replace the older SQLite version with the newer version of SQLite
and recompile and the application will run faster.
There are no API changes nor modifications
to compilation procedures.


But as with any query planner change, upgrading to the NGQP does carry
a small risk of introducing performance regressions. The problem here is
not that the NGQP is incorrect or buggy or inferior to the legacy query
planner. Given reliable information about the selectivity of indexes,
the NGQP should always pick a plan that is as good as before, or better.
The problem is that some applications may be using low\-quality and
low\-selectivity indexes without having run [ANALYZE](lang_analyze.html). The older query
planners look at many fewer possible implementations for each query and
so they may have stumbled over a good plan by stupid luck. The NGQP, on
the other hand, looks at many more query plan possibilities, and it may
choose a different query plan that
works better in theory, assuming good indexes, but which gives a performance
regression in practice, because of the shape of the data.


Key points:


* The NGQP will always find an equal or better query plan, compared to
 prior query planners, as long as it
 has access to accurate [ANALYZE](lang_analyze.html) data in the [SQLITE\_STAT1](fileformat2.html#stat1tab) file.
* The NGQP will always find a good query plan
 as long as the schema does not contain indexes that have more than
 about 10 or 20 rows with the same value in the left\-most column of the
 index.


Not all applications meet these conditions. Fortunately,
the NGQP will still usually find good query plans, even without these conditions.
However, cases do arise (rarely) where performance regressions can occur.



