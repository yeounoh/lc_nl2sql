## 3\.4\.  The N Nearest Neighbors or "N3" Heuristic


The NGQP uses a new heuristic for seeking the best path through the
graph: "N Nearest Neighbors" (hereafter "N3"). With N3, instead of
choosing just one nearest neighbor for each step, the algorithm keeps
track of the N bests paths at each step for some small integer N.


Suppose N\=4\. Then for the TPC\-H Q8 graph, the first step finds
the four shortest paths to visit any single node in the graph:




> R (cost: 3\.56\)   
> 
>  N1 (cost: 5\.52\)   
> 
>  N2 (cost: 5\.52\)   
> 
>  P (cost: 7\.71\)


The second step finds the four shortest paths to visit two nodes
beginning with one of the four paths from the previous step. In the
case where two or more paths are equivalent (they have the same set of
visited nodes, though possibly in a different order) only the
first and lowest\-cost path is retained. We have:



> R\-N1 (cost: 7\.03\)   
> 
>  R\-N2 (cost: 9\.08\)   
> 
>  N2\-N1 (cost: 11\.04\)   
> 
>  R\-P {cost: 11\.27}


The third step starts with the four shortest two\-node paths and finds
the four shortest three\-node paths:



> R\-N1\-N2 (cost: 12\.55\)   
> 
>  R\-N1\-C (cost: 13\.43\)   
> 
>  R\-N1\-P (cost: 14\.74\)   
> 
>  R\-N2\-S (cost: 15\.08\)


And so forth. There are 8 nodes in the TPC\-H Q8 query,
so this process repeats a total of 8
times. In the general case of a K\-way join, the storage requirement
is O(N) and the computation time is O(K\*N), which is significantly faster
than the O(2K) exact solution.


But what value to choose for N? One might try N\=K. This makes the
algorithm O(K2)
which is actually still quite efficient, since the
maximum value of K is 64 and K rarely exceeds 10\.
But that is not enough for the TPC\-H Q8
problem. With N\=8 on TPC\-H Q8 the N3 algorithm finds
the solution R\-N1\-C\-O\-L\-S\-N2\-P with a cost of 29\.78\.
That is a big improvement over NN, but it is still
not optimal. N3 finds the optimal solution for TPC\-H Q8
when N is 10 or greater.


The initial implementation of NGQP chooses N\=1 for simple queries, N\=5
for two\-way joins and N\=10 for all joins with three or more tables. This
formula for selecting N might change in subsequent releases.



