## 4\.1\. WAL File Format


A [WAL file](wal.html#walfile) consists of a header followed by zero or more "frames".
Each frame records the revised content of a single page from the
database file. All changes to the database are recorded by writing
frames into the WAL. Transactions commit when a frame is written that
contains a commit marker. A single WAL can and usually does record 
multiple transactions. Periodically, the content of the WAL is
transferred back into the database file in an operation called a
"checkpoint".


A single WAL file can be reused multiple times. In other words, the
WAL can fill up with frames and then be checkpointed and then new
frames can overwrite the old ones. A WAL always grows from beginning
toward the end. Checksums and counters attached to each frame are
used to determine which frames within the WAL are valid and which
are leftovers from prior checkpoints.


The WAL header is 32 bytes in size and consists of the following eight
big\-endian 32\-bit unsigned integer values:



*WAL Header Format*  



| Offset | Size | Description |
| --- | --- | --- |
| 0 | 4 | Magic number. 0x377f0682 or 0x377f0683 |
| 4 | 4 | File format version. Currently 3007000\. |
| 8 | 4 | Database page size. Example: 1024 |
| 12 | 4 | Checkpoint sequence number |
| 16 | 4 | Salt\-1: random integer incremented with each checkpoint |
| 20 | 4 | Salt\-2: a different random number for each checkpoint |
| 24 | 4 | Checksum\-1: First part of a checksum on the first 24 bytes of header |
| 28 | 4 | Checksum\-2: Second part of the checksum on the first 24 bytes of header |



Immediately following the wal\-header are zero or more frames. Each
frame consists of a 24\-byte frame\-header followed by a *page\-size* bytes
of page data. The frame\-header is six big\-endian 32\-bit unsigned 
integer values, as follows:




*WAL Frame Header Format*  



| Offset | Size | Description |
| --- | --- | --- |
| 0 | 4 | Page number |
| 4 | 4 | For commit records, the size of the database file in pages  after the commit. For all other records, zero. |
| 8 | 4 | Salt\-1 copied from the WAL header |
| 12 | 4 | Salt\-2 copied from the WAL header |
| 16 | 4 | Checksum\-1: Cumulative checksum up through and including this page |
| 20 | 4 | Checksum\-2: Second half of the cumulative checksum. |



A frame is considered valid if and only if the following conditions are
true:


1. The salt\-1 and salt\-2 values in the frame\-header match
 salt values in the wal\-header
2. The checksum values in the final 8 bytes of the frame\-header
 exactly match the checksum computed consecutively on the
 first 24 bytes of the WAL header and the first 8 bytes and
 the content of all frames
 up to and including the current frame.



