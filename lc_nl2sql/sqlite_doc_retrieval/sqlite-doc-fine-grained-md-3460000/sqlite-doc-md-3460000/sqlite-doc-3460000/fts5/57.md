## 7\.2\. Custom Auxiliary Functions


 Implementing a custom auxiliary function is similar to implementing a
[scalar SQL function](appfunc.html). The implementation
should be a C function of type fts5\_extension\_function, defined as follows:




```
typedef struct Fts5ExtensionApi Fts5ExtensionApi;
typedef struct Fts5Context Fts5Context;
typedef struct Fts5PhraseIter Fts5PhraseIter;

typedef void (*fts5_extension_function)(
  const Fts5ExtensionApi *pApi,   /* API offered by current FTS version */
  Fts5Context *pFts,              /* First arg to pass to pApi functions */
  sqlite3_context *pCtx,          /* Context for returning result/error */
  int nVal,                       /* Number of values in apVal[] array */
  sqlite3_value **apVal           /* Array of trailing arguments */
);

```

 The implementation is registered with the FTS5 module by calling the
xCreateFunction() method of the fts5\_api object. If there is already an
auxiliary function with the same name, it is replaced by the new function.
If a non\-NULL xDestroy parameter is passed to xCreateFunction(), it is invoked
with a copy of the pUserData pointer passed as the only argument when the
database handle is closed or when the registered auxiliary function is
replaced.



 If successful, xCreateFunction() returns SQLITE\_OK. Otherwise, it
returns an SQLite error code. In this case the xDestroy function is **not**
invoked.



 The final three arguments passed to the auxiliary function callback 
(pCtx, nVal and apVal above) are similar to the three arguments passed to the
implementation of a scalar SQL function. The apVal\[] array contains all
SQL arguments except the first passed to the auxiliary function. The
implementation should return a result or error via the content handle pCtx.



 The first argument passed to an auxiliary function callback is a pointer
to a structure (pApi above) containing methods that may be invoked
in order to obtain information regarding the current query or row. The second
argument is an opaque handle (pFts above) that should be passed as the
first argument to any such method invocation. For example, the following
auxiliary function returns the total number of tokens in all columns of the
current row:




```
/*
** Implementation of an auxiliary function that returns the number
** of tokens in the current row (including all columns).
*/
static void column_size_imp(
  const Fts5ExtensionApi *pApi,
  Fts5Context *pFts,
  sqlite3_context *pCtx,
  int nVal,
  sqlite3_value **apVal
){
  int rc;
  int nToken;
  rc = pApi->xColumnSize(pFts, -1, &nToken);
  if( rc==SQLITE_OK ){
    sqlite3_result_int(pCtx, nToken);
  }else{
    sqlite3_result_error_code(pCtx, rc);
  }
}

```

The following section describes the API offered to auxiliary function
implementations in detail. Further examples may be found in the "fts5\_aux.c"
file of the source code.




