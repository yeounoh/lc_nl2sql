## 9\.2\. The FTS Index (%\_idx and %\_data tables)


The FTS index is an ordered key\-value store where the keys are document
terms or term prefixes and the associated values are "doclists". A doclist is a
packed array of varints that encodes the position of each instance of the term
within the FTS5 table. The position of a single term instance is defined as the
combination of:



* The rowid of the FTS5 table row it appears in,
* The index of the column the term instance appears in (columns are
 numbered from left to right starting from zero), and
* The offset of the term within the column value (i.e. the number of
 tokens that appear within the column value before this one).


The FTS index contains up to (nPrefix\+1\) entries for each token in the
data set, where nPrefix is the number of defined [prefix indexes](#prefix_indexes).



Keys associated with the main FTS index (the one that is not a prefix
index) are prefixed with the character "0". Keys for the first prefix
index are prefixed with "1". Keys for the second prefix index are
prefixed with "2", and so on. For example, if the token "document" is
inserted into an FTS5 table with [prefix indexes](#prefix_indexes)
specified by prefix\="2 4", then the keys added to the FTS index would be
"0document", "1do" and "2docu".



The FTS index entries are not stored in a single tree or hash table
structure. Instead, they are stored in a series of immutable b\-tree like
structures referred to as "segment b\-trees". Each time a write to the FTS5
table is committed, one or more (but usually just one) new segment b\-trees
are added containing both the new entries and tombstones for any deleted
entries. When the FTS index is queried, the reader queries each segment
b\-tree in turn and merges the results, giving priority to newer data.



Each segment b\-tree is assigned a numerical level. When a new segment
b\-tree is written to the database as part of committing a transaction,
it is assigned to level 0\. Segment b\-trees belonging to a single level are
periodically merged together to create a single, larger segment b\-tree
that is assigned to the next level (i.e. level 0 segment b\-trees are
merged to become a single level 1 segment b\-tree). Thus the numerically
larger levels contain older data in (usually) larger segment b\-trees.
Refer to the
['automerge'](#the_automerge_configuration_option),
['crisismerge'](#the_crisismerge_configuration_option) and
['usermerge'](#the_usermerge_configuration_option) options, along
with the
['merge'](#the_merge_command) and
['optimize'](#the_optimize_command) commands for details on how to
control the merging.



In cases where the doclist associated with a term or term prefix is very
large, there may be an associated [doclist
index](#doclist_index_format). A doclist index is similar to the set of internal nodes of a b\-tree.
It allows a large doclist to be efficiently queried for rowids or ranges of
rowids. For example, when processing a query like:




```
SELECT ... FROM fts_table('term') WHERE rowid BETWEEN ? AND ?

```

FTS5 uses the segment b\-tree index to locate the doclist for term "term",
then uses its doclist index (assuming it is present) to efficiently identify
the subset of matches with rowids in the required range.



