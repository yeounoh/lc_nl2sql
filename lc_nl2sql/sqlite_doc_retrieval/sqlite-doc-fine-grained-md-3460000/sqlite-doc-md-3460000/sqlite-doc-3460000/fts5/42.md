## 6\.7\. The 'merge' Command



```
INSERT INTO ft(ft, rank) VALUES('merge', 500);

```

 This command merges b\-tree structures together until roughly N pages
of merged data have been written to the database, where N is the absolute
value of the parameter specified as part of the 'merge' command. The size of
each page is as configured by the [FTS5 pgsz option](fts5.html#the_pgsz_configuration_option).



 If the parameter is a positive value, B\-tree structures are only eligible
for merging if one of the following is true:



* There are U or more such b\-trees on a
 single level (see the documentation for the [FTS5 automerge option](fts5.html#the_automerge_configuration_option)
 for an explanation of b\-tree levels), where U is the value assigned
 to the [FTS5 usermerge option](fts5.html#the_usermerge_configuration_option) option.
* A merge has already been started (perhaps by a 'merge' command that
 specified a negative parameter).


 It is possible to tell whether or not the 'merge' command found any
b\-trees to merge together by checking the value returned by the
[sqlite3\_total\_changes()](c3ref/total_changes.html) API before and after the command is executed. If
the difference between the two values is 2 or greater, then work was performed.
If the difference is less than 2, then the 'merge' command was a no\-op. In this
case there is no reason to execute the same 'merge' command again, at least
until after the FTS table is next updated.



 If the parameter is negative, and there are B\-tree structures on more than
one level within the FTS index, all B\-tree structures are assigned to the same
level before the merge operation is commenced. Additionally, if the parameter
is negative, the value of the usermerge configuration option is not
respected \- as few as two b\-trees from the same level may be merged together.



 The above means that executing the 'merge' command with a negative
parameter until the before and after difference in the return value of
[sqlite3\_total\_changes()](c3ref/total_changes.html) is less than two optimizes the FTS index in the
same way as the [FTS5 optimize command](fts5.html#the_optimize_command). However, if a new b\-tree is added
to the FTS index while this process is ongoing, FTS5 will move the new
b\-tree to the same level as the existing b\-trees and restart the merge. To
avoid this, only the first call to 'merge' should specify a negative parameter.
Each subsequent call to 'merge' should specify a positive value so that the
merge started by the first call is run to completion even if new b\-trees are
added to the FTS index.




