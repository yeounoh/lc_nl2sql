### 4\.4\.4\. External Content Table Pitfalls



It is the responsibility of the user to ensure that an FTS5 external content
table (one with a non\-empty content\= option) is kept consistent with the
content table itself (the table named by the content\= option). If these are
allowed to become inconsistent, then the results of queries against the FTS5
table may become unintuitive and appear inconsistent.




In these situations, the apparently inconsistent results produced by queries
against the FTS5 external content table may be understood as follows:



* If the query does not use the full\-text index \- does not contain a 
 MATCH operator or equivalent table\-valued function syntax \- then the
 query is effectively passed through to the external content table. In
 this case the contents of the FTS index have no effect on the results
 of the query.
* If the query does use the full text index, then the FTS5 module
 queries it for the set of rowid values corresponding to documents that match
 the query. For each such rowid, it then runs a query similar to the following
 to retrieve any required column values, where '?' is replaced by the rowid
 value, and \<content\> and \<content\_rowid\> by the values specified
 for the content\= and content\_rowid\= options:



```
SELECT <content_rowid>, <cols> FROM <content> WHERE <content_rowid> = ?;

```


For example, if a database is created using the following script:




```
-- Create and populate a table. 
CREATE TABLE tbl(a INTEGER PRIMARY KEY, t TEXT);
INSERT INTO tbl VALUES(1, 'all that glitters');
INSERT INTO tbl VALUES(2, 'is not gold');

-- Create an external content FTS5 table 
CREATE VIRTUAL TABLE ft USING fts5(t, content='tbl', content_rowid='a');

```

then the content table contains two rows, but the FTS index contains no
entries corresponding to them. In this case the following queries will return
inconsistent results as follows:




```
-- Returns 2 rows.  Because the query does not use the FTS index, it is
-- effectively executed against table 'tbl' directly, and so returns
-- both rows.
SELECT * FROM t1;

-- Returns 0 rows.  This query does use the FTS index, which currently
-- contains no entries. So it returns 0 rows.
SELECT rowid, t FROM t1('gold')

```


Alternatively, if the database were created and populated as follows:




```
-- Create and populate a table. 
CREATE TABLE tbl(a INTEGER PRIMARY KEY, t TEXT);

-- Create an external content FTS5 table 
CREATE VIRTUAL TABLE ft USING fts5(t, content='tbl', content_rowid='a');
INSERT INTO ft(rowid, t) VALUES(1, 'all that glitters');
INSERT INTO ft(rowid, t) VALUES(2, 'is not gold');

```

then the content table is empty, but the FTS index contains entries for
6 different tokens. In this case the following queries will return
inconsistent results as follows:




```
-- Returns 0 rows.  Since it does not use the FTS index, the query is
-- passed directly through to table 'tbl', which contains no data.
SELECT * FROM t1;

-- Returns 1 row. The "rowid" field of the returned row is 2, and
-- the "t" field set to NULL. "t" is set to NULL because when the external
-- content table "tbl" was queried for the data associated with the row
-- with a=2 ("a" is the content_rowid column), none could be found.
SELECT rowid, t FROM t1('gold')

```

As described in the previous section, triggers on the content table are
a good way to ensure that an FTS5 external content table is kept consistent.
However, triggers are only fired when rows are inserted, updated or deleted
in the content table. This means that if, for example, a database is created
as follows:




```
-- Create and populate a table. 
CREATE TABLE tbl(a INTEGER PRIMARY KEY, t TEXT);
INSERT INTO tbl VALUES(1, 'all that glitters');
INSERT INTO tbl VALUES(2, 'is not gold');

-- Create an external content FTS5 table 
CREATE VIRTUAL TABLE ft USING fts5(t, content='tbl', content_rowid='a');

-- Create triggers to keep the FTS5 table up to date
CREATE TRIGGER tbl_ai AFTER INSERT ON tbl BEGIN
  INSERT INTO ft(rowid, t) VALUES (new.a, new.t);
END;
<similar triggers for update + delete>

```

then the content table and external content FTS5 table are inconsistent, as
creating the triggers does not copy existing rows from the content table
into the FTS index. The triggers are only able to ensure that updates made to
the content table after they are created are reflected in the FTS index.



In this, and any other situation where the FTS index and its content table
have become inconsistent, the ['rebuild'](#the_rebuild_command)
command may be used to completely discard the contents of the FTS index and
rebuild it based on the current contents of the content table.




