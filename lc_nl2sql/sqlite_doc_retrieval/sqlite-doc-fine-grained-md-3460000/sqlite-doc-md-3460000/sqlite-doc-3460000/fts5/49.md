# 7\. Extending FTS5


FTS5 features APIs allowing it to be extended by:



* Adding new auxiliary functions implemented in C, and
* Adding new tokenizers, also implemented in C.


 The built\-in tokenizers and auxiliary functions described in this
document are all implemented using the publicly available API described
below.



 Before a new auxiliary function or tokenizer implementation may be
registered with FTS5, an application must obtain a pointer to the "fts5\_api"
structure. There is one fts5\_api structure for each database connection with
which the FTS5 extension is registered. To obtain the pointer, the application
invokes the SQL user\-defined function fts5() with a single argument. That
argument must be set to a pointer to a pointer to an fts5\_api object
using the [sqlite3\_bind\_pointer()](c3ref/bind_blob.html) interface.
The following example code demonstrates the technique:




```
/*
** Return a pointer to the fts5_api pointer for database connection db.
** If an error occurs, return NULL and leave an error in the database
** handle (accessible using sqlite3_errcode()/errmsg()).
*/
fts5_api *fts5_api_from_db(sqlite3 *db){
  fts5_api *pRet = 0;
  sqlite3_stmt *pStmt = 0;

  if( SQLITE_OK==sqlite3_prepare(db, "SELECT fts5(?1)", -1, &pStmt, 0) ){
    sqlite3_bind_pointer(pStmt, 1, (void*)&pRet, "fts5_api_ptr", NULL);
    sqlite3_step(pStmt);
  }
  sqlite3_finalize(pStmt);
  return pRet;
}

```

**Backwards Compatibility Warning:**
Prior to SQLite version 3\.20\.0 (2017\-08\-01\), the fts5() worked slightly
differently. Older applications that extend FTS5 must be revised to use
the new technique shown above.



 The fts5\_api structure is defined as follows. It exposes three methods,
one each for registering new auxiliary functions and tokenizers, and one for
retrieving existing tokenizer. The latter is intended to facilitate the
implementation of "tokenizer wrappers" similar to the built\-in
porter tokenizer.




```
typedef struct fts5_api fts5_api;
struct fts5_api {
  int iVersion;                   /* Currently always set to 2 */

  /* Create a new tokenizer */
  int (*xCreateTokenizer)(
    fts5_api *pApi,
    const char *zName,
    void *pUserData,
    fts5_tokenizer *pTokenizer,
    void (*xDestroy)(void*)
  );

  /* Find an existing tokenizer */
  int (*xFindTokenizer)(
    fts5_api *pApi,
    const char *zName,
    void **ppUserData,
    fts5_tokenizer *pTokenizer
  );

  /* Create a new auxiliary function */
  int (*xCreateFunction)(
    fts5_api *pApi,
    const char *zName,
    void *pUserData,
    fts5_extension_function xFunction,
    void (*xDestroy)(void*)
  );
};

```

 To invoke a method of the fts5\_api object, the fts5\_api pointer itself
should be passed as the methods first argument followed by the other, method
specific, arguments. For example:




```
rc = pFts5Api->xCreateTokenizer(pFts5Api, ... other args ...);

```

 The fts5\_api structure methods are described individually in the following
sections.




