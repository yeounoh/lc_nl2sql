### 5\.1\.1\. The bm25() function


 The built\-in auxiliary function bm25() returns a real value indicating
how well the current row matches the full\-text query. The better the match,
the numerically smaller the value returned. A query such as the following may
be used to return matches in order from best to worst match:




```
SELECT * FROM fts WHERE fts MATCH ? ORDER BY bm25(fts)

```

 In order to calculate a documents score, the full\-text query is separated
 into its component phrases. The bm25 score for document *D* and
 query *Q* is then calculated as follows:



 ![](images/fts5_formula1.png)


 In the above, *nPhrase* is the number of phrases in the query.
 *\|D\|* is the number of tokens in the current document, and
 *avgdl* is the average number of tokens in all documents within the
 FTS5 table. *k1* and *b* are both constants,
 hard\-coded at 1\.2 and 0\.75 respectively.



 The "\-1" term at the start of the formula is not found in most
implementations of the BM25 algorithm. Without it, a better match is assigned
a numerically higher BM25 score. Since the default sorting order is
"ascending", this means that appending "ORDER BY bm25(fts)" to a query would
cause results to be returned in order from worst to best. The "DESC" keyword
would be required in order to return the best matches first. In order to
avoid this pitfall, the FTS5 implementation of BM25 multiplies the result
by \-1 before returning it, ensuring that better matches are assigned
numerically lower scores.



 *IDF(qi)* is the inverse\-document\-frequency of query
 phrase *i*. It is calculated as follows, where *N* is the total
 number of rows in the FTS5 table and *n(qi)* is the total
 number of rows that contain at least one instance of phrase *i*:



 ![](images/fts5_formula2.png)


 Finally, *f(qi,D)* is the phrase frequency of phrase
*i*. By default, this is simply the number of occurrences of the phrase
within the current row. However, by passing extra real value arguments to
the bm25() SQL function, each column of the table may be assigned a different
weight and the phrase frequency calculated as follows:



 ![](images/fts5_formula3.png)


 where *wc* is the weight assigned to column *c* and
*n(qi,c)* is the number of occurrences of phrase *i* in
column *c* of the current row. The first argument passed to bm25()
following the table name is the weight assigned to the leftmost column of
the FTS5 table. The second is the weight assigned to the second leftmost
column, and so on. If there are not enough arguments for all table columns,
remaining columns are assigned a weight of 1\.0\. If there are too many
trailing arguments, the extras are ignored. For example:




```
-- Assuming the following schema:
CREATE VIRTUAL TABLE email USING fts5(sender, title, body);

-- Return results in bm25 order, with each phrase hit in the "sender"
-- column considered the equal of 10 hits in the "body" column, and
-- each hit in the "title" column considered as valuable as 5 hits in
-- the "body" column.
SELECT * FROM email WHERE email MATCH ? ORDER BY bm25(email, 10.0, 5.0);

```

Refer to wikipedia for
[more information regarding
BM25](https://en.wikipedia.org/wiki/Okapi_BM25) and its variants.




