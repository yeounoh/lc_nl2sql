## First Improvement: Replace ZIP with SQLite



Let us suppose that instead of using a ZIP archive to store its files,
OpenDocument used a very simple SQLite database with the following
single\-table schema:


> ```
> 
> CREATE TABLE OpenDocTree(
>   filename TEXT PRIMARY KEY,  -- Name of file
>   filesize BIGINT,            -- Size of file after decompression
>   content BLOB                -- Compressed file content
> );
> 
> ```



For this first experiment, nothing else about the file format is changed.
The OpenDocument is still a pile\-of\-files, only now each file is a row
in an SQLite database rather than an entry in a ZIP archive.
This simple change does not use the power of a relational
database. Even so, this simple change shows some improvements.



Surprisingly, using SQLite in place of ZIP makes the presentation
file smaller. Really. One would think that a relational database file
would be larger than a ZIP archive, but at least in the case of NeoOffice
that is not so. The following is an actual screen\-scrape showing
the sizes of the same NeoOffice presentation, both in its original 
ZIP archive format as generated by NeoOffice (self2014\.odp), and 
as repacked as an SQLite database using the 
[SQLAR](https://www.sqlite.org/sqlar/doc/trunk/README.md) utility:


> ```
> 
> -rw-r--r--  1 drh  staff  10514994 Jun  8 14:32 self2014.odp
> -rw-r--r--  1 drh  staff  10464256 Jun  8 14:37 self2014.sqlar
> -rw-r--r--  1 drh  staff  10416644 Jun  8 14:40 zip.odp
> 
> ```



The SQLite database file ("self2014\.sqlar") is about a
half percent smaller than the equivalent ODP file! How can this be?
Apparently the ZIP archive generator logic in NeoOffice
is not as efficient as it could be, because when the same pile\-of\-files
is recompressed using the command\-line "zip" utility, one gets a file
("zip.odp") that is smaller still, by another half percent, as seen
in the third line above. So, a well\-written ZIP archive
can be slightly smaller than the equivalent SQLite database, as one would
expect. But the difference is slight. The key take\-away is that an
SQLite database is size\-competitive with a ZIP archive.


The other advantage to using SQLite in place of
ZIP is that the document can now be updated incrementally, without risk
of corrupting the document if a power loss or other crash occurs in the
middle of the update. (Remember that writes to 
[SQLite databases are atomic](atomiccommit.html).) True, all the
content is still kept in a single big XML file ("content.xml") which must
be completely rewritten if so much as a single character changes. But
with SQLite, only that one file needs to change. The other 77 files in the
repository can remain unaltered. They do not all have to be rewritten,
which in turn makes "File/Save" run much faster and saves wear on SSDs.

