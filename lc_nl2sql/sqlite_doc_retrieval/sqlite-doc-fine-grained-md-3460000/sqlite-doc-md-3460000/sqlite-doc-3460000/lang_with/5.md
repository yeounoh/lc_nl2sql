## 3\.2\. Hierarchical Query Examples


Consider a table that describes the members of an organization as
well as the chain\-of\-command within that organization:




> ```
> 
> CREATE TABLE org(
>   name TEXT PRIMARY KEY,
>   boss TEXT REFERENCES org,
>   height INT,
>   -- other content omitted
> );
> 
> ```


Every member in the organization has a name, and most members have
a single boss. (The head of the whole organization has a NULL
"boss" field.) The rows of the "org" table form a tree.



Here is a query that computes the average height over everyone
in Alice's organization, including Alice:




> ```
> 
> WITH RECURSIVE
>   works_for_alice(n) AS (
>     VALUES('Alice')
>     UNION
>     SELECT name FROM org, works_for_alice
>      WHERE org.boss=works_for_alice.n
>   )
> SELECT avg(height) FROM org
>  WHERE org.name IN works_for_alice;
> 
> ```


The next example uses two 
common table expressions in a single WITH clause. 
The following table records a family tree:




> ```
> 
> CREATE TABLE family(
>   name TEXT PRIMARY KEY,
>   mom TEXT REFERENCES family,
>   dad TEXT REFERENCES family,
>   born DATETIME,
>   died DATETIME -- NULL if still alive
>   -- other content
> );
> 
> ```


The "family" table is similar to the earlier "org" table except that 
now there are two parents to each member.
We want to know all living ancestors of Alice, from oldest to youngest.
An ordinary common table expression, "parent\_of", is defined first. That
ordinary CTE is a view that can be used to find all parents of any
individual. That ordinary CTE is then used in the "ancestor\_of\_alice"
recursive CTE. The recursive CTE is then used in the final query:




> ```
> 
> WITH RECURSIVE
>   parent_of(name, parent) AS
>     (SELECT name, mom FROM family UNION SELECT name, dad FROM family),
>   ancestor_of_alice(name) AS
>     (SELECT parent FROM parent_of WHERE name='Alice'
>      UNION ALL
>      SELECT parent FROM parent_of JOIN ancestor_of_alice USING(name))
> SELECT family.name FROM ancestor_of_alice, family
>  WHERE ancestor_of_alice.name=family.name
>    AND died IS NULL
>  ORDER BY born;
> 
> ```



