# 3\. Recovery



Recovery is the process of rebuilding the WAL\-index so that it is
synchronized with the WAL.




Recovery is run by the first thread to connect to a WAL\-mode database.
Recovery restores the WAL\-index so that it accurately describes the
WAL file. If there is no WAL file present when the first thread connects
to the database, there is nothing to recover, but the recovery process
still runs to initialize the WAL\-index.




If the WAL\-index is implemented as a memory\-mapped file and that file is
read\-only to the first thread to connect, then that thread creates an
private heap\-memory ersazt WAL\-index and runs the recovery routine to
populate that private WAL\-index. The same data results, but it is held
privately rather that being written into the public shared memory area.




Recovery works by doing a single pass over the WAL, from beginning to end.
The checksums are verified on each frame of the WAL as it is read. The
scan stops at the end of the file or at the first invalid checksum.
The [mxFrame](walformat.html#mxframe) field is set to the index of the last valid commit frame
in WAL. Since WAL frame numbers are indexed starting with 1, mxFrame is
also the number of valid frames in the WAL. A "commit frame" is a frame
that has a non\-zero value in bytes 4 through 7 of the frame header.
Since the recovery procedure has no way of knowing how many frames of the
WAL might have previously been copied back into the database, it initializes
the [nBackfill](walformat.html#nbackfill) value to zero.




During recovery of the global shared\-memory WAL\-index, exclusive locks are
held on WAL\_WRITE\_LOCK, WAL\_CKPT\_LOCK, WAL\_RECOVER\_LOCK, and WAL\_READ\_LOCK(1\) through WAL\_READ\_LOCK(4\). In other words, all locks associated with the
WAL\-index except for WAL\_READ\_LOCK(0\) are held exclusively. This prevents
any other thread from writing the database and from reading any transactions
that are held in the WAL, until the recovery is complete.


*This page last modified on [2022\-01\-08 05:02:57](https://sqlite.org/docsrc/honeypot) UTC* 


