### 2\.3\.1\. How the various locks are used


The following rules show how each of the locks is used.



* **SQLITE\_LOCK\_SHARED**



All connections hold SQLITE\_LOCK\_SHARED continuously while attached
to a WAL\-mode database. This is true for both read/write connections
and read\-only connections.
The SQLITE\_LOCK\_SHARED lock is held even by connections that are
not within transaction.
This is different from rollback mode, where the SQLITE\_LOCK\_SHARED is
released at the end of each transaction.
* **SQLITE\_LOCK\_EXCLUSIVE**



Connections hold an exclusive lock when change in between WAL mode
and any of the various rollback\-modes. Connections might also attempt to
obtain an EXCLUSIVE lock when they disconnect from WAL mode. If
a connection is able to obtain an EXCLUSIVE lock, that means it is the
only connection to the database and so it may attempt to checkpoint
and then delete the WAL\-index and WAL files.



When a connection is holding a SHARED lock on the main database,
that will prevent any other connection from acquiring the EXCLUSIVE
lock, which in turn prevents the WAL\-index and WAL files from being
deleted out from under other users, and prevents a transition out of
WAL\-mode while other users are accessing the database in WAL\-mode.
* **WAL\_WRITE\_LOCK**



The WAL\_WRITE\_LOCK is only locked exclusively. There is never a shared
lock taken on WAL\_WRITE\_LOCK.



An EXCLUSIVE WAL\_WRITE\_LOCK is held by any connection that is appending
content to the end of the WAL. Hence, only a single process at a time
can append content to the WAL. If a [WAL reset](fileformat2.html#walreset) occurs as a consequence of
a write, then the [nBackfill](walformat.html#nbackfill) field of the WAL\-index header is reset to
zero while holding this lock.


An EXCLUSIVE is also held WAL\_WRITE\_LOCK, and on several other locking
bytes, when a connection is running [recovery](walformat.html#recovery) on the shared WAL\-index.
* **WAL\_CKPT\_LOCK**



The WAL\_CKPT\_LOCK is only locked exclusively. There is never a shared
lock taken on WAL\_CKPT\_LOCK.



An EXCLUSIVE WAL\_CKPT\_LOCK is held by any connection that is running
a [checkpoint](wal.html#ckpt). The [nBackfill](walformat.html#nbackfill) field of the WAL\-index header may be
increased while holding this exclusive lock, but it may not be decreased.


An EXCLUSIVE is also held WAL\_CKPT\_LOCK, and on several other locking
bytes, when a connection is running [recovery](walformat.html#recovery) on the shared WAL\-index.
* **WAL\_RECOVER\_LOCK**



The WAL\_RECOVER\_LOCK is only locked exclusively. There is never a shared
lock taken on WAL\_RECOVER\_LOCK.



An EXCLUSIVE WAL\_RECOVER\_LOCK is held by any connection that is running
[recovery](walformat.html#recovery) to reconstruct the shared WAL\-index.



A read\-only connection that is rebuilding its private heap\-memory WAL\-index
does not hold this lock. (It cannot, since read\-only connections are not
allowed to hold any exclusive locks.) This lock is only held when rebuilding
the global shared WAL\-index contained in the memory\-mapped SHM file.



In addition to locking this byte, a connection running [recovery](walformat.html#recovery) also
gets an exclusive lock on all other WAL locks except for WAL\_READ\_LOCK(0\).
* **WAL\_READ\_LOCK(N)**



There are five separate read locks, numbers 0 through 4\.
Read locks may be either SHARED or EXCLUSIVE.
Connections obtain a shared lock on one of the read locks bytes while
they are within a transaction.
Connections also obtain an exclusive lock on read locks, one at a time,
for the brief moment while they are updating the values of the corresponding
read\-marks.
Read locks 1 through 4 are held exclusively when running [recovery](walformat.html#recovery).



Each read lock byte corresponds to one of the five 32\-bit read\-mark
integers located in bytes 100 through 119 of the WAL\-index header, as
follows:





| Lock Name | Lock offset | Read\-mark name | Read\-mark offset |
| --- | --- | --- | --- |
| WAL\_READ\_LOCK(0\) | 123 | read\-mark\[0] | 100\..103 |
| WAL\_READ\_LOCK(1\) | 124 | read\-mark\[1] | 104\..107 |
| WAL\_READ\_LOCK(2\) | 125 | read\-mark\[2] | 108\..111 |
| WAL\_READ\_LOCK(3\) | 126 | read\-mark\[3] | 112\..115 |
| WAL\_READ\_LOCK(4\) | 127 | read\-mark\[4] | 116\..119 |




When a connection holds a shared lock on WAL\_READ\_LOCK(N), that is a
promise by the connection that it will use the WAL and not the database
file for any database pages that are modified by the first
read\-mark\[N] entries in the WAL.
The read\-mark\[0] is always zero. If a connection holds a shared lock
on WAL\_READ\_LOCK(0\), that means the connection expects to be able to ignore
the WAL and read any content it wants from the main database.
If N\>0 then the connection is free to use more of the WAL file beyond
read\-mark\[N] if it wants to, up to the first mxFrame frames.
But when a connection holds a shared lock on WAL\_READ\_LOCK(0\), that is a
promise that it will never read content from the WAL
and will acquire all content directly from the main database.



When a checkpoint runs, if it sees a lock on WAL\_READ\_LOCK(N), then it
must not move WAL content into the main database for more than the first
read\-mark\[N] frames. Were it to do so, it would overwrite content that
the process holding the lock was expecting to be able to read out of the
main database file. A consequence of if this is that f the WAL file
contains more than read\-mark\[N] frames (if mxFrame\>read\-mark\[N]
for any read\-mark for which WAL\_READ\_LOCK(N) is held by another process),
then the checkpoint cannot run to completion.



When a writer wants to [reset the WAL](fileformat2.html#walreset), it must ensure that there are
no locks on WAL\_READ\_LOCK(N) for N\>0 because such locks indicate
that some other connection is still using the current WAL file and 
a [WAL reset](fileformat2.html#walreset) would delete content out from those other connections. It is
ok for a [WAL reset](fileformat2.html#walreset) to occur if other connections are holding WAL\_READ\_LOCK(0\)
because by holding WAL\_READ\_LOCK(0\), those other connections are promising
not to use any content from the WAL.


