## 3\.3\.  Lookaside memory allocator


SQLite [database connections](c3ref/sqlite3.html) make many
small and short\-lived memory allocations.
This occurs most commonly when compiling SQL statements using
[sqlite3\_prepare\_v2()](c3ref/prepare.html) but also to a lesser extent when running
[prepared statements](c3ref/stmt.html) using [sqlite3\_step()](c3ref/step.html). These small memory
allocations are used to hold things such as the names of tables
and columns, parse tree nodes, individual query results values,
and B\-Tree cursor objects. There are consequently
many calls to malloc() and free() \- so many calls that malloc() and
free() end up using a significant fraction of the CPU time assigned
to SQLite.


SQLite [version 3\.6\.1](releaselog/3_6_1.html) (2008\-08\-06\)
introduced the lookaside memory allocator to
help reduce the memory allocation load. In the lookaside allocator,
each [database connection](c3ref/sqlite3.html) preallocates a single large chunk of memory
(typically in the range of 60 to 120 kilobytes) and divides that chunk
up into small fixed\-size "slots" of around 100 to 1000 byte each. This
becomes the lookaside memory pool. Thereafter, memory allocations
associated with the [database connection](c3ref/sqlite3.html) and that are not too large
are satisfied using one of the lookaside pool slots rather than by calling
the general\-purpose memory allocator. Larger allocations continue to
use the general\-purpose memory allocator, as do allocations that occur
when the lookaside pool slots are all checked out. 
But in many cases, the memory
allocations are small enough and there are few enough outstanding that
the new memory requests can be satisfied from the lookaside
pool.


Because lookaside allocations are always the same size, the allocation
and deallocation algorithms are very quick. There is no
need to coalesce adjacent free slots or search for a slot
of a particular size. Each [database connection](c3ref/sqlite3.html) maintains a singly\-linked
list of unused slots. Allocation requests simply pull the first
element of this list. Deallocations simply push the element back onto
the front of the list.
Furthermore, each [database connection](c3ref/sqlite3.html) is assumed to already be
running in a single thread (there are mutexes already in
place to enforce this) so no additional mutexing is required to 
serialize access to the lookaside slot freelist.
Consequently, lookaside memory
allocations and deallocations are very fast. In speed tests on
Linux and Mac OS X workstations, SQLite has shown overall performance
improvements as high as 10% and 15%, depending on the workload how
and lookaside is configured.


The size of the lookaside memory pool has a global default value
but can also be configured on a connection\-by\-connection basis.
To change the default size of the lookaside memory pool at
compile\-time, use the 
[\-DSQLITE\_DEFAULT\_LOOKASIDE\=*SZ,N*](compile.html#default_lookaside)
option.
To change the default size of the lookaside memory pool at
start\-time, use the [sqlite3\_config()](c3ref/config.html) interface:



> ```
> 
> [sqlite3_config](c3ref/config.html)([SQLITE_CONFIG_LOOKASIDE](c3ref/c_config_covering_index_scan.html#sqliteconfiglookaside), sz, cnt);
> 
> ```


The "sz" parameter is the size in bytes of each lookaside slot.
The "cnt" parameter is
the total number of lookaside memory slots per database connection.
The total amount
of lookaside memory allocated to each [database connection](c3ref/sqlite3.html) is
sz\*cnt bytes. 



The lookaside pool can be changed for an individual
[database connection](c3ref/sqlite3.html) "db" using this call:



> ```
> 
> [sqlite3_db_config](c3ref/db_config.html)(db, [SQLITE_DBCONFIG_LOOKASIDE](c3ref/c_dbconfig_defensive.html#sqlitedbconfiglookaside), pBuf, sz, cnt);
> 
> ```


The "pBuf" parameter is a pointer to memory space that will be
used for the lookaside memory pool. If pBuf is NULL, then SQLite
will obtain its own space for the memory pool using [sqlite3\_malloc()](c3ref/free.html).
The "sz" and "cnt" parameters are the size of each lookaside slot
and the number of slots, respectively. If pBuf is not NULL, then it
must point to at least sz\*cnt bytes of memory.


The lookaside configuration can only be changed while there are
no outstanding lookaside allocations for the database connection.
Hence, the configuration should be set immediately after creating the 
database connection using [sqlite3\_open()](c3ref/open.html) (or equivalent) and before
evaluating any SQL statements on the connection.


