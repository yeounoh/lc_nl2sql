# 4\.  Mathematical Guarantees Against Memory Allocation Failures


The problem of dynamic memory allocation, and specifically the
problem of a memory allocator breakdown, has been studied by
J. M. Robson and the results published as:



> J. M. Robson. "Bounds for Some Functions Concerning Dynamic
> Storage Allocation". *Journal of the Association for
> Computing Machinery*, Volume 21, Number 8, July 1974,
> pages 491\-499\.


Let us use the following notation (similar but not identical to
Robson's notation):



> | **N** | The amount of raw memory needed by the memory allocation system in order to guarantee that no memory allocation will ever fail. |
> | --- | --- |
> | **M** | The maximum amount of memory that the application ever has checked out at any point in time. |
> | **n** | The ratio of the largest memory allocation to the smallest. We assume that every memory allocation size is an integer multiple of the smallest memory allocation size. |


Robson proves the following result:



> **N** \= **M**\*(1 \+ (log2 **n**)/2\) \- **n** \+ 1


Colloquially, the Robson proof shows that in order to guarantee
breakdown\-free operation, any memory allocator must use a memory pool
of size **N** which exceeds the maximum amount of memory ever
used **M** by a multiplier that depends on **n**, 
the ratio of the largest to the smallest allocation size. In other
words, unless all memory allocations are of exactly the same size
(**n**\=1\) then the system needs access to more memory than it will
ever use at one time. Furthermore, we see that the amount of surplus
memory required grows rapidly as the ratio of largest to smallest
allocations increases, and so there is strong incentive to keep all
allocations as near to the same size as possible.


Robson's proof is constructive. 
He provides an algorithm for computing a sequence of allocation
and deallocation operations that will lead to an allocation failure due to
memory fragmentation if available memory is as much as one byte
less than **N**.
And, Robson shows that a power\-of\-two first\-fit memory allocator
(such as implemented by [memsys5](malloc.html#memsys5)) will never fail a memory allocation
provided that available memory is **N** or more bytes.


The values **M** and **n** are properties of the application.
If an application is constructed in such a way that both **M** and
**n** are known, or at least have known upper bounds, and if the
application uses
the [memsys5](malloc.html#memsys5) memory allocator and is provided with **N** bytes of
available memory space using [SQLITE\_CONFIG\_HEAP](c3ref/c_config_covering_index_scan.html#sqliteconfigheap)
then Robson proves that no memory allocation request will ever fail
within the application.
To put this another way, the application developer can select a value
for **N** that will guarantee that no call to any SQLite interface
will ever return [SQLITE\_NOMEM](rescode.html#nomem). The memory pool will never become
so fragmented that a new memory allocation request cannot be satisfied.
This is an important property for
applications where a software fault could cause injury, physical harm, or
loss of irreplaceable data.


