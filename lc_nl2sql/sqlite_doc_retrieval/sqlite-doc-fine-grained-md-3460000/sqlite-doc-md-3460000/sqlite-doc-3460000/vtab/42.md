### 2\.3\.4\. Enforcing Required Parameters On Table\-Valued Functions


The SQLITE\_CONSTRAINT return from xBestIndex
is useful for [table\-valued functions](vtab.html#tabfunc2) that
have required parameters. If the aConstraint\[].usable field is false
for one of the required parameter, then the xBestIndex method should
return SQLITE\_CONSTRAINT. If a required field does not appear in
the aConstraint\[] array at all, that means that the corresponding
parameter is omitted from the input SQL. In that case, xBestIndex
should set an error message in pVTab\-\>zErrMsg and return
SQLITE\_ERROR. To summarize:



1. The aConstraint\[].usable value for a required parameter is
false → return SQLITE\_CONSTRAINT.
2. A required parameter does not appears anywhere in
the aConstraint\[] array →
Set an error message in pVTab\-\>zErrMsg and return
SQLITE\_ERROR


The following example will better illustrate the use of SQLITE\_CONSTRAINT
as a return value from xBestIndex:




```
SELECT * FROM realtab, tablevaluedfunc(realtab.x);

```

Assuming that the first hidden column of "tablevaluedfunc" is "param1",
the query above is semantically equivalent to this:




```
SELECT * FROM realtab, tablevaluedfunc
 WHERE tablevaluedfunc.param1 = realtab.x;

```

The query planner must decide between many possible implementations
of this query, but two plans in particular are of note:



1. Scan all
rows of realtab and for each row, find rows in tablevaluedfunc where
param1 is equal to realtab.x
2. Scan all rows of tablevalued func and for each row find rows
in realtab where x is equal to tablevaluedfunc.param1\.


The xBestIndex method will be invoked once for each of the potential
plans above. For plan 1, the aConstraint\[].usable flag for the
SQLITE\_CONSTRAINT\_EQ constraint on the param1 column will be true because
the right\-hand side value for the "param1 \= ?" constraint will be known,
since it is determined by the outer realtab loop.
But for plan 2, the aConstraint\[].usable flag for "param1 \= ?" will be false
because the right\-hand side value is determined by an inner loop and is thus
an unknown quantity. Because param1 is a required input to the table\-valued
functions, the xBestIndex method should return SQLITE\_CONSTRAINT when presented 
with plan 2, indicating that a required input is missing. This forces the
query planner to select plan 1\.




