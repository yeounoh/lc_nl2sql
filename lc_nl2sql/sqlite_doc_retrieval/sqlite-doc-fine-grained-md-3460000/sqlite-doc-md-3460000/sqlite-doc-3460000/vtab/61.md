## 2\.22\. The xIntegrity Method



If the iVersion for an sqlite3\_module is 4 or more and the xIntegrity
method is not NULL, then the [PRAGMA integrity\_check](pragma.html#pragma_integrity_check) and
[PRAGMA quick\_check](pragma.html#pragma_quick_check) commands will invoke
xIntegrity as part of its processing. If the xIntegrity method writes
an error message string into the fifth parameter, then PRAGMA integrity\_check
will report that error as part of its output. So, in other words, the
xIntegrity method allows the [PRAGMA integrity\_check](pragma.html#pragma_integrity_check) command to verify
the integrity of content stored in a virtual table.




The xIntegrity method is called with five parameters:



* **pVTab** → A pointer to the [sqlite3\_vtab](c3ref/vtab.html) object that is the
 virtual table being checked.
* **zSchema** → The name of the schema ("main", "temp", etc.) in which
 the virtual table is defined.
* **zTabName** → The name of the virtual table.
* **mFlags** → A flag to indicate whether this is an "integrity\_check"
 or a "quick\_check". Currently, this parameter will always be either 0 or 1,
 though future versions of SQLite might use other bits of the integer to
 indicate additional processing options.
* **pzErr** → This parameter points to a "char\*" that is initialized
 to NULL. The xIntegrity() implementation should make \*pzErr point to
 an error string obtained from sqlite3\_malloc() or equivalent if it finds
 any problems.



The xIntegrity method should normally return SQLITE\_OK \- even if it finds
problems in the content of the virtual table. Any other error code
means that the xIntegrity method itself encountered problems while trying
to evaluate the virtual table content. So, for example, if the inverted
index for [FTS5](fts5.html) is found to be internally inconsistent, then the xIntegrity
method should write an appropriate error message into the pzErr parameter
and return SQLITE\_OK. But if the xIntegrity method is unable to complete its
evaluation of the virtual table content due to running out of memory, then
it should return SQLITE\_NOMEM.




If an error message is generated,
space to hold the error message string should be obtained from [sqlite3\_malloc64()](c3ref/free.html)
or the equivalent. Ownership of the error message string will pass to the
SQLite core when xIntegrity returns. The core will make sure that
[sqlite3\_free()](c3ref/free.html) is invoked to reclaim the memory which it has finished
with the error message. The PRAGMA integrity\_check command that invokes the
xIntegrity method does not change the returned error message. The xIntegrity
method itself should include the name of the virtual table as part of the
message. The zSchema and zName parameters are provided to make that easier.




The mFlags parameter is currently a boolean value (either 0 or 1\) that indicates
if the xIntegrity method was called due to [PRAGMA integrity\_check](pragma.html#pragma_integrity_check) (mFlags\=\=0\)
or due to [PRAGMA quick\_check](pragma.html#pragma_quick_check) (mFlags\=\=1\). Generally speaking, the xIntegrity
method should do whatever validity checking it can accomplish in linear time
regardless, but only do checking that requires superlinear time if
(mFlags\&1\)\=\=0. Future versions of SQLite might
use higher\-order bits of the mFlags parameter to indicate additional
processing options.




Support for the
xIntegrity method was added in SQLite version 3\.44\.0 (2023\-11\-01\).
In that same release, the xIntegrity method was added to many built\-in
virtual tables, such as [FTS3](fts3.html), [FTS5](fts5.html), and [RTREE](rtree.html) so that the content
of those tables will henceforth be automatically checked for consistency
when [PRAGMA integrity\_check](pragma.html#pragma_integrity_check) is run.


*This page last modified on [2023\-12\-05 14:43:20](https://sqlite.org/docsrc/honeypot) UTC* 


