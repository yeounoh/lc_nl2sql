## 9\.3\. Segment B\-Tree Format



 Segment b\-trees are prefix\-compressed b\+\-trees. There is one segment b\-tree
 for each row in the %\_segdir table (see above). The root node of the segment
 b\-tree is stored as a blob in the "root" field of the corresponding row
 of the %\_segdir table. All other nodes (if any exist) are stored in the
 "blob" column of the %\_segments table. Nodes within the %\_segments table are
 identified by the integer value in the blockid field of the corresponding
 row. The following table describes the fields of the %\_segdir table:





| Column | Interpretation |
| --- | --- |
| level | Between them, the contents of the "level" and "idx" fields define the  relative age of the segment b\-tree. The smaller the value stored in the  "level" field, the more recently the segment b\-tree was created. If two  segment b\-trees are of the same "level", the segment with the larger  value stored in the "idx" column is more recent. The PRIMARY KEY constraint  on the %\_segdir table prevents any two segments from having the same value  for both the "level" and "idx" fields. |
| idx | See above. |
| start\_block | The blockid that corresponds to the node with the smallest blockid that  belongs to this segment b\-tree. Or zero if the entire segment b\-tree  fits on the root node. If it exists, this node is always a leaf node. |
| leaves\_end\_block | The blockid that corresponds to the leaf node with the largest blockid  that belongs to this segment b\-tree. Or zero if the entire segment b\-tree  fits on the root node. |
| end\_block | This field may contain either an integer or a text field consisting of  two integers separated by a space character (unicode codepoint 0x20\).   The first, or only, integer is the blockid that corresponds to the interior  node with the largest blockid that belongs to this segment b\-tree. Or zero  if the entire segment b\-tree fits on the root node. If it exists, this node  is always an interior node.   The second integer, if it is present, is the aggregate size of all data  stored on leaf pages in bytes. If the value is negative, then the segment  is the output of an unfinished incremental\-merge operation, and the  absolute value is current size in bytes. |
| root | Blob containing the root node of the segment b\-tree. |



 Apart from the root node, the nodes that make up a single segment b\-tree are
 always stored using a contiguous sequence of blockids. Furthermore, the
 nodes that make up a single level of the b\-tree are themselves stored as
 a contiguous block, in b\-tree order. The contiguous sequence of blockids
 used to store the b\-tree leaves are allocated starting with the blockid
 value stored in the "start\_block" column of the corresponding %\_segdir row,
 and finishing at the blockid value stored in the "leaves\_end\_block"
 field of the same row. It is therefore possible to iterate through all the
 leaves of a segment b\-tree, in key order, by traversing the %\_segments
 table in blockid order from "start\_block" to "leaves\_end\_block".



