## 4\.0 The Mutex Subsystem


 SQLite has always been threadsafe in the sense that it is safe to
 use different SQLite database connections in different threads at the
 same time. The constraint was that the same database connection
 could not be used in two separate threads at once. SQLite version 3\.5\.0
 relaxes this constraint. 




 In order to allow multiple threads to use the same database connection
 at the same time, SQLite must make extensive use of mutexes. And for
 this reason a new mutex subsystem as been added. The mutex subsystem
 as the following interface:




> ```
> 
> sqlite3_mutex *sqlite3_mutex_alloc(int);
> void sqlite3_mutex_free(sqlite3_mutex*);
> void sqlite3_mutex_enter(sqlite3_mutex*);
> int sqlite3_mutex_try(sqlite3_mutex*);
> void sqlite3_mutex_leave(sqlite3_mutex*);
> 
> ```


 Though these routines exist for the use of the SQLite core, 
 application code is free to use these routines as well, if desired.
 A mutex is an [sqlite3\_mutex](c3ref/mutex.html) object. The [sqlite3\_mutex\_alloc()](c3ref/mutex_alloc.html)
 routine allocates a new mutex object and returns a pointer to it.
 The argument to [sqlite3\_mutex\_alloc()](c3ref/mutex_alloc.html) should be 
 [SQLITE\_MUTEX\_FAST](c3ref/c_mutex_fast.html) or [SQLITE\_MUTEX\_RECURSIVE](c3ref/c_mutex_fast.html) for non\-recursive
 and recursive mutexes, respectively. If the underlying system does
 not provide non\-recursive mutexes, then a recursive mutex can be
 substituted in that case. The argument to [sqlite3\_mutex\_alloc()](c3ref/mutex_alloc.html)
 can also be a constant designating one of several static mutexes:
 * [SQLITE\_MUTEX\_STATIC\_MAIN](c3ref/c_mutex_fast.html)* [SQLITE\_MUTEX\_STATIC\_MEM](c3ref/c_mutex_fast.html)* [SQLITE\_MUTEX\_STATIC\_MEM2](c3ref/c_mutex_fast.html)* [SQLITE\_MUTEX\_STATIC\_PRNG](c3ref/c_mutex_fast.html)* [SQLITE\_MUTEX\_STATIC\_LRU](c3ref/c_mutex_fast.html)


 These static mutexes are reserved for use internally by SQLite
 and should not be used by the application. The static mutexes
 are all non\-recursive.




 The [sqlite3\_mutex\_free()](c3ref/mutex_alloc.html) routine should be used to deallocate
 a non\-static mutex. If a static mutex is passed to this routine
 then the behavior is undefined.




 The [sqlite3\_mutex\_enter()](c3ref/mutex_alloc.html) attempts to enter the mutex and blocks
 if another threads is already there. [sqlite3\_mutex\_try()](c3ref/mutex_alloc.html) attempts
 to enter and returns [SQLITE\_OK](rescode.html#ok) on success or [SQLITE\_BUSY](rescode.html#busy) if another
 thread is already there. [sqlite3\_mutex\_leave()](c3ref/mutex_alloc.html) exits a mutex.
 The mutex is held until the number of exits matches the number of
 entrances. If [sqlite3\_mutex\_leave()](c3ref/mutex_alloc.html) is called on a mutex that 
 the thread is not currently holding, then the behavior is undefined.
 If any routine is called for a deallocated mutex, then the behavior
 is undefined.




 The SQLite source code provides multiple implementations of these
 APIs, suitable for varying environments. If SQLite is compiled with
 the SQLITE\_THREADSAFE\=0 flag then a no\-op mutex implementation that 
 is fast but does no real mutual exclusion is provided. That 
 implementation is suitable for use in single\-threaded applications
 or applications that only use SQLite in a single thread. Other
 real mutex implementations are provided based on the underlying
 operating system.




 Embedded applications may wish to provide their own mutex implementation.
 If SQLite is compiled with the \-DSQLITE\_MUTEX\_APPDEF\=1 compile\-time flag
 then the SQLite core provides no mutex subsystem and a mutex subsystem
 that matches the interface described above must be provided by the
 application that links against SQLite.



