## 3\.1\. Capturing a Changeset


 The example code below demonstrates the steps involved in capturing a
changeset while executing SQL commands. In summary:



1. A session object (type sqlite3\_session\*) is created by making a
 call to the [sqlite3session\_create()](session/sqlite3session_create.html) API function.

 

A single session object monitors changes made to a single database
 (i.e. "main", "temp" or an attached database) via a single
 sqlite3\* database handle.
2. The session object is configured with a set of tables to monitor
 changes on.

 

 By default a session object does not monitor changes on any
 database table. Before it does so it must be configured. There
 are three ways to configure the set of tables to monitor changes
 on:
 


	* By explicitly specifying tables using one call to
	 [sqlite3session\_attach()](session/sqlite3session_attach.html) for each table, or
	* By specifying that all tables in the database should be monitored
	 for changes using a call to [sqlite3session\_attach()](session/sqlite3session_attach.html) with a
	 NULL argument, or
	* By configuring a callback to be invoked the first time each table
	 is written to that indicates to the session module whether or
	 not changes on the table should be monitored. The example code below uses the second of the methods enumerated
 above \- it monitors for changes on all database tables.
3. Changes are made to the database by executing SQL statements. The
 session object records these changes.
4. A changeset blob is extracted from the session object using a call
 to [sqlite3session\_changeset()](session/sqlite3session_changeset.html) (or, if using patchsets, a call to
 the [sqlite3session\_patchset()](session/sqlite3session_patchset.html) function).
5. The session object is deleted using a call to the
 [sqlite3session\_delete()](session/sqlite3session_delete.html) API function.

 

 It is not necessary to delete a session object after extracting
 a changeset or patchset from it. It can be left attached to the
 database handle and will continue monitoring for changes on the
 configured tables as before. However, if
 [sqlite3session\_changeset()](session/sqlite3session_changeset.html) or [sqlite3session\_patchset()](session/sqlite3session_patchset.html) is
 called a second time on a session object, the changeset or patchset
 will contain *all* changes that have taken place on the connection
 since the session was created. In other words,
 a session object is not reset or
 zeroed by a call to sqlite3session\_changeset() or
 sqlite3session\_patchset().



```
/*
** Argument zSql points to a buffer containing an SQL script to execute
** against the database handle passed as the first argument. As well as
** executing the SQL script, this function collects a changeset recording
** all changes made to the "main" database file. Assuming no error occurs,
** output variables (*ppChangeset) and (*pnChangeset) are set to point
** to a buffer containing the changeset and the size of the changeset in
** bytes before returning SQLITE_OK. In this case it is the responsibility
** of the caller to eventually free the changeset blob by passing it to
** the sqlite3_free function.
**
** Or, if an error does occur, return an SQLite error code. The final
** value of (*pChangeset) and (*pnChangeset) are undefined in this case.
*/
int sql_exec_changeset(
  sqlite3 *db,                  /* Database handle */
  const char *zSql,             /* SQL script to execute */
  int *pnChangeset,             /* OUT: Size of changeset blob in bytes */
  void **ppChangeset            /* OUT: Pointer to changeset blob */
){
  sqlite3_session *pSession = 0;
  int rc;

  /* Create a new session object */
  rc = sqlite3session_create(db, "main", &pSession);

  /* Configure the session object to record changes to all tables */
  if( rc==SQLITE_OK ) rc = sqlite3session_attach(pSession, NULL);

  /* Execute the SQL script */
  if( rc==SQLITE_OK ) rc = sqlite3_exec(db, zSql, 0, 0, 0);

  /* Collect the changeset */
  if( rc==SQLITE_OK ){
    rc = sqlite3session_changeset(pSession, pnChangeset, ppChangeset);
  }

  /* Delete the session object */
  sqlite3session_delete(pSession);

  return rc;
}

```

