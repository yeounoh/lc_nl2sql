## The ORDER BY clause


For historical reasons, and for efficiency, all sorting is currently 
done in memory.


SQLite implements the ORDER BY clause using a special
set of instructions to control an object called a sorter. In the
inner\-most loop of the query, where there would normally be
a Callback instruction, instead a record is constructed that
contains both callback parameters and a key. This record
is added to the sorter (in a linked list). After the query loop 
finishes, the list of records is sorted and this list is walked. For 
each record on the list, the callback is invoked. Finally, the sorter
is closed and memory is deallocated.


We can see the process in action in the following query:



> ```
> 
> SELECT * FROM examp ORDER BY one DESC, two;
> 
> ```



> addr  opcode        p1     p2     p3                                        
> 
> \-\-\-\-  \-\-\-\-\-\-\-\-\-\-\-\-  \-\-\-\-\-  \-\-\-\-\-  \-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-  
> 
> 0     ColumnName    0      0      one                                  
> 
> 1     ColumnName    1      0      two                                  
> 
> 2     Integer       0      0                                           
> 
> 3     OpenRead      0      3      examp                                
> 
> 4     VerifyCookie  0      909                                              
> 
> 5     Rewind        0      14                                               
> 
> 6     Column        0      0                                           
> 
> 7     Column        0      1                                           
> 
> 8     SortMakeRec   2      0                                                
> 
> 9     Column        0      0                                           
> 
> 10    Column        0      1                                           
> 
> 11    SortMakeKey   2      0      D\+                                   
> 
> 12    SortPut       0      0                                                
> 
> 13    Next          0      6                                                
> 
> 14    Close         0      0                                                
> 
> 15    Sort          0      0                                                
> 
> 16    SortNext      0      19                                               
> 
> 17    SortCallback  2      0                                                
> 
> 18    Goto          0      16                                               
> 
> 19    SortReset     0      0                                           
> 
> 20    Halt          0      0


There is only one sorter object, so there are no instructions to open 
or close it. It is opened automatically when needed, and it is closed 
when the VDBE program halts.


The query loop is built from instructions 5 through 13\. Instructions
6 through 8 build a record that contains the azData\[] values for a single
invocation of the callback. A sort key is generated by instructions
9 through 11\. Instruction 12 combines the invocation record and the
sort key into a single entry and puts that entry on the sort list.
The P3 argument of instruction 11 is of particular interest. The
sort key is formed by prepending one character from P3 to each string
and concatenating all the strings. The sort comparison function will
look at this character to determine whether the sort order is
ascending or descending, and whether to sort as a string or number. 
In this example, the first column should be sorted as a string 
in descending order so its prefix is "D" and the second column should 
sorted numerically in ascending order so its prefix is "\+". Ascending 
string sorting uses "A", and descending numeric sorting uses "\-".


After the query loop ends, the table being queried is closed at
instruction 14\. This is done early in order to allow other processes
or threads to access that table, if desired. The list of records
that was built up inside the query loop is sorted by the instruction
at 15\. Instructions 16 through 18 walk through the record list
(which is now in sorted order) and invoke the callback once for
each record. Finally, the sorter is closed at instruction 19\.


