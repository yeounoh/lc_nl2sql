# 7\. Implementation Of Shared\-Memory For The WAL\-Index


The [wal\-index](walformat.html#shm) is implemented using an ordinary file that is
mmapped for robustness. Early (pre\-release) implementations of WAL mode
stored the wal\-index in volatile shared\-memory, such as files created in
/dev/shm on Linux or /tmp on other unix systems. The problem
with that approach is that processes with a different root directory
(changed via [chroot](http://en.wikipedia.org/wiki/Chroot))
will see different files and hence use different shared memory areas,
leading to database corruption. Other methods for creating nameless
shared memory blocks are not portable across the various flavors of
unix. And we could not find any method to create nameless shared
memory blocks on windows. The only way we have found to guarantee
that all processes accessing the same database file use the same shared
memory is to create the shared memory by mmapping a file in the same
directory as the database itself.


Using an ordinary disk file to provide shared memory has the 
disadvantage that it might actually do unnecessary disk I/O by
writing the shared memory to disk. However, the developers do not
think this is a major concern since the wal\-index rarely exceeds
32 KiB in size and is never synced. Furthermore, the wal\-index 
backing file is deleted when the last database connection disconnects,
which often prevents any real disk I/O from ever happening.


Specialized applications for which the default implementation of
shared memory is unacceptable can devise alternative methods via a
custom [VFS](vfs.html). 
For example, if it is known that a particular database
will only be accessed by threads within a single process, the wal\-index
can be implemented using heap memory instead of true shared memory.



