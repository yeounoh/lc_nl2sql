## 6\.1\. The Legacy xGeom Callback


The legacy xGeom callback is invoked with four arguments. The first
argument is a pointer to an sqlite3\_rtree\_geometry structure which provides
information about how the SQL function was invoked. The second argument
is the number of coordinates in each r\-tree entry, and is always the same
for any given R\*Tree. The number of coordinates is 2 for a 1\-dimensional R\*Tree,
4 for a 2\-dimensional R\*Tree, 6 for a 3\-dimensional R\*Tree, and so forth.
The third argument, aCoord\[], is an array of nCoord coordinates that defines
a bounding box to be tested. The last argument is a pointer into which
the callback result should be written. The result is zero
if the bounding\-box defined by aCoord\[] is completely outside
the region defined by the xGeom callback and the result is non\-zero if
the bounding\-box is inside or overlaps with the xGeom region. The xGeom
callback should normally return SQLITE\_OK. If xGeom returns anything other
than SQLITE\_OK, then the r\-tree query will abort with an error.



The sqlite3\_rtree\_geometry structure that the first argument to the
xGeom callback points to has a structure shown below. The exact same
sqlite3\_rtree\_geometry
structure is used for every callback for same MATCH operator in the same
query. The contents of the sqlite3\_rtree\_geometry
structure are initialized by SQLite but are
not subsequently modified. The callback is free to make changes to the
pUser and xDelUser elements of the structure if desired.




```
typedef struct sqlite3_rtree_geometry sqlite3_rtree_geometry;
struct sqlite3_rtree_geometry {
  void *pContext;                 /* Copy of pContext passed to s_r_g_c() */
  int nParam;                     /* Size of array aParam */
  double *aParam;                 /* Parameters passed to SQL geom function */
  void *pUser;                    /* Callback implementation user data */
  void (*xDelUser)(void *);       /* Called by SQLite to clean up pUser */
};

```

The pContext member of the sqlite3\_rtree\_geometry
structure is always set to a copy of the pContext
argument passed to sqlite3\_rtree\_geometry\_callback() when the
callback is registered. The aParam\[] array (size nParam) contains the parameter
values passed to the SQL function on the right\-hand side of the MATCH operator.
In the example "circle" query above, nParam would be set to 3 and the aParam\[]
array would contain the three values 45\.3, 22\.9 and 5\.0\.



The pUser and xDelUser members of the sqlite3\_rtree\_geometry structure are
initially set to NULL. The pUser variable may be set by the callback
implementation to any arbitrary value that may be useful to subsequent
invocations of the callback within the same query (for example, a
pointer to a complicated data structure used to test for region intersection).
If the xDelUser variable is set to a non\-NULL value, then after the
query has finished running SQLite automatically invokes it with the
value of the pUser variable as the only argument. In other words, xDelUser
may be set to a destructor function for the pUser value.



The xGeom callback always does a depth\-first search of the r\-tree.




